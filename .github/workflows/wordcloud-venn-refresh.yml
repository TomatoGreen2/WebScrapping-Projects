name: wordcloud-venn-refresh

on:
  workflow_dispatch: {}
  schedule:
    - cron: "10 6 * * 1,4"

permissions:
  contents: read
  id-token: write   # REQUIRED for GitHub OIDC â†’ AWS

concurrency:
  group: wordcloud-venn-refresh
  cancel-in-progress: true

jobs:
  refresh:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: eu-central-1
      AWS_ROLE_ARN: arn:aws:iam::239956809107:role/Git_NEON_AWS

      # Tell refresh.py which SSM parameters to load (examples)
      # These should match what you created in Parameter Store.
      SSM_PARAM_NEON_DATABASE_URL: /myapp/neon_database_url
      SSM_PARAM_GUARDIAN_API_KEY: /myapp/guardian_api_key

      # Optional: store RSS URLs in SSM too, or keep them hardcoded in script
      # If you DO store them in SSM, set these names and refresh.py will load them.
      # SSM_PARAM_RSS_OMEGA: /wordcloud/SOURCE1_FEED
      # SSM_PARAM_RSS_CN: /wordcloud/SOURCE2_FEED

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---- AWS OIDC authentication ----
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # ---- Python setup ----
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r .github/workflows/requirements.txt

      # ---- Run ETL refresh ----
      - name: Run refresh script (truncate + repopulate DB)
        run: |
          python scripts/refresh.py
