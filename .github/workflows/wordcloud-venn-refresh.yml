name: wordcloud-venn-refresh

on:
  workflow_dispatch: {}
  schedule:
    - cron: "10 6 * * 1,4"

permissions:
  contents: read
  id-token: write   # REQUIRED for GitHub OIDC â†’ AWS

concurrency:
  group: wordcloud-venn-refresh
  cancel-in-progress: true

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    # Run shell steps from WordCloudVenn/ by default (fixes path issues)
    defaults:
      run:
        working-directory: WordCloudVenn

    env:
      AWS_REGION: eu-central-1
      AWS_ROLE_ARN: arn:aws:iam::239956809107:role/Git_NEON_AWS

      # SSM parameter names
      SSM_PARAM_NEON_DATABASE_URL: /myapp/neon_database_url
      SSM_PARAM_GUARDIAN_API_KEY: /myapp/guardian_api_key

      # Optional RSS in SSM:
      # SSM_PARAM_RSS_OMEGA: /wordcloud/SOURCE1_FEED
      # SSM_PARAM_RSS_CN: /wordcloud/SOURCE2_FEED

      # Make spaCy model cache location explicit
      SPACY_CACHE_DIR: ~/.cache/spacy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---- Debug: show repo layout ----
      - name: Debug repo layout
        shell: bash
        run: |
          set -euxo pipefail
          echo "PWD=$(pwd)"
          echo "Top-level repo listing:"
          ls -la ..
          echo "Working directory listing (WordCloudVenn):"
          ls -la .
          echo "Find requirements.txt:"
          find .. -maxdepth 4 -name "requirements.txt" -print
          echo "Find refresh.py:"
          find .. -maxdepth 6 -name "refresh.py" -print

      # ---- AWS OIDC authentication ----
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # ---- Python setup ----
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            WordCloudVenn/requirements.txt

      # Cache spaCy model downloads (prevents slow repeated downloads)
      - name: Cache spaCy models
        uses: actions/cache@v4
        with:
          path: ~/.cache/spacy
          key: ${{ runner.os }}-spacy-en_core_web_sm-v1

      - name: Install dependencies
        shell: bash
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Install spaCy model (en_core_web_sm)
        shell: bash
        run: |
          set -euxo pipefail
          python -m spacy download en_core_web_sm

      # ---- Run ETL refresh ----
      - name: Run refresh script (truncate + repopulate DB)
        shell: bash
        run: |
          set -euxo pipefail
          python scripts/refresh.py
